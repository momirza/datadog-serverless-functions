# Datadog Forwarder

AWS Lambda function to ship ELB, S3, CloudTrail, VPC, CloudFront logs from S3 buckets, and Lambda metrics, traces and logs from CloudWatch logs to Datadog.

## Features

- Forward CloudWatch, ELB, S3, CloudTrail, VPC and CloudFront logs to Datadog
- Forward S3 events to Datadog
- Forward Kinesis data stream events to Datadog, only CloudWatch logs are supported
- Forward custom metrics from AWS Lambda functions via CloudWatch logs
- Generate and submit enhanced Lambda metrics (`aws.lambda.enhanced.*`) parsed from the AWS REPORT log: duration, billed_duration, max_memory_used, and estimated_cost

## Installation

Use the [AWS Serverless Repository](https://serverlessrepo.aws.amazon.com/applications/arn:aws:serverlessrepo:us-east-1:464622532012:applications~Datadog-Log-Forwarder) to deploy the Lambda in your AWS account.

## Basic Settings

The basic settings can be configured through the SAM app installation interface. Some of them are simply mapped to environment variables that can be updated after the installation from the Lambda configuration console.

### Application Name

DO **NOT** change unless for advanced use cases. If changed, you **MUST** provide the same application name when upgrade in the future.

### Datadog API Key (REQUIRED)

The Datadog API key for your Datadog platform MUST be provided, it can be found here:

* Datadog US Site: https://app.datadoghq.com/account/settings#api
* Datadog EU Site: https://app.datadoghq.eu/account/settings#api

Provide the API key using one of the following SAM application settings:

* `DdApiKeySecretArn` (or environment variable `DD_API_KEY_SECRET_ARN`): Recommended. The Secret ARN to fetch the Datadog API key from Secrets Manager. `KMSKeyId` also needs to be provided if a customer managed CMK is used for encryption.
  * Permission `secretsmanager:GetSecretValue` to access the provided Secret ARN will be added automatically.
  * Permission `kms:Decrypt` to access the `KMSKeyId`, if provided, will be added automatically.
* `DdKmsApiKey` (or environment variable `DD_KMS_API_KEY`): Recommended. The Datadog API Key encrypted by KMS. `KMSKeyId` also needs to be provided for decryption.
  * Permission `kms:Decrypt` to access the `KMSKeyId`, will be added automatically.
* `DdApiKey` (or environment variable `DD_API_KEY`): NOT recommended. The Datadog API Key in plain text.

### Custom Tags

Add custom tags to logs forwarded by your function using the `DdTags` setting (or environment variable `DD_TAGS`). It must be a comma-delimited string with no trailing comma, e.g., `env:prod,stack:classic`.

### Datadog Site

Define your Datadog Site to send data to using the `DdSite` setting (or environment variable `DD_SITE`). It must be either `datadoghq.com` for the Datadog US site or `datadoghq.eu` for the Datadog EU site.

### Function Name

You can optionally customize the Datadog Forwarder Lambda function name using the `FunctionName` setting. DO **NOT** change unless you need to install multiple forwarders in the same region for advanced use cases. If changed, you **MUST** provide the same function name when upgrade in the future.

### Reserved Concurrency

You can optionally customize the reserved concurrency for the Datadog Forwarder Lambda function using the `ReservedConcurrency` setting.

### Log Retention

You can optionally customize the CloudWatch log retention for logs generated by the Datadog Forwarder Lambda function using the `LogRetentionInDays` setting.

## Advanced Settings

The advanced settings can be configured after the installation as environment variables from the Lambda configuration console.

### Send logs through TCP or HTTP

By default, the forwarder sends logs using HTTPS through the port `443`. To send logs over a SSL encrypted TCP connection, set the environment variable `DD_USE_TCP` to `true`.

### Proxy

Ensure that you disable SSL between the lambda and your proxy by setting `DD_NO_SSL` to `true`
 
Two environment variables can be used to forward logs through a proxy:

* `DD_URL`: Define the proxy endpoint to forward the logs to.
* `DD_PORT`: Define the proxy port to forward the logs to.

### Fetch Lambda Tags (Beta)

If the `DD_FETCH_LAMBDA_TAGS` env variable is set to `true` then the log forwarder will fetch Lambda tags using [GetResources](https://docs.aws.amazon.com/resourcegroupstagging/latest/APIReference/API_GetResources.html) API calls and apply them to the `aws.lambda.enhanced.*` metrics parsed from the REPORT log. For this to work the log forwarder function needs to be given the `tag:GetResources` permission. The tags are cached in memory so that they'll only be fetched when the function cold starts or when the TTL (1 hour) expires. The log forwarder increments the `aws.lambda.enhanced.get_resources_api_calls` metric for each API call made.

### Scrubbing / Redaction rules

Multiple scrubbing options are available.  `REDACT_IP` and `REDACT_EMAIL` match against hard-coded patterns, while `DD_SCRUBBING_RULE` allows users to supply a regular expression.
- To use `REDACT_IP`, add it as an environment variable and set the value to `true`.
    - Text matching `\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}` is replaced with `xxx.xxx.xxx.xxx`.
- To use `REDACT_EMAIL`, add it as an environment variable and set the value to `true`.
	- Text matching `[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+` is replaced with `xxxxx@xxxxx.com`.
- To use `DD_SCRUBBING_RULE`, add it as a environment variable, and supply a regular expression as the value.
    - Text matching the user-supplied regular expression is replaced with `xxxxx`, by default.
    - Use the `DD_SCRUBBING_RULE_REPLACEMENT` environment variable to supply a replacement value instead of `xxxxx`.
- Scrubbing rules are applied to the full JSON-formatted log, including any metadata that is automatically added by the Lambda function.
- Each instance of a pattern match is replaced until no more matches are found in each log.

### Filtering rules

Use the `EXCLUDE_AT_MATCH` OR `INCLUDE_AT_MATCH` environment variables to filter logs based on a regular expression match:

- To use `EXCLUDE_AT_MATCH` add it as an environment variable and set its value to a regular expression. Logs matching the regular expression are excluded.
- To use `INCLUDE_AT_MATCH` add it as an environment variable and set its value to a regular expression. If not excluded by `EXCLUDE_AT_MATCH`, logs matching the regular expression are included.
- If a log matches both the inclusion and exclusion criteria, it is excluded.
- Filtering rules are applied to the full JSON-formatted log, including any metadata that is automatically added by the function.

### Multiline Log support for s3

If there are multiline logs in s3, set `DD_MULTILINE_LOG_REGEX_PATTERN` environment variable to the specified regex pattern to detect for a new log line.

- Example: for multiline logs beginning with pattern `11/10/2014`: `DD_MULTILINE_LOG_REGEX_PATTERN="\d{2}\/\d{2}\/\d{4}"`

### Disable log forwarding

The datadog forwarder **ALWAYS** forwards logs by default. If you do NOT use the Datadog log management product, you **MUST** set environment variable `DD_FORWARD_LOG` to `False`, to avoid sending logs to Datadog. The forwarder will then only forward other observability data, such as metrics.

### Disable SSL validation

If you need to ignore SSL certificate validation when forwarding logs using HTTPS, you can set the environment variable `DD_SKIP_SSL_VALIDATION` to `True`.
This will still encrypt the traffic between the forwarder and the endpoint provided with `DD_URL` but will not check if the destination SSL certificate is valid. 

## Test

Hit the `Test` button, and select `CloudWatch Logs` as the sample event. If the test "succeeded", you are all set! The test log doesn't show up in the platform.

## Triggers

Follow the steps below to set up triggers on the Datadog Forwarder.

1. Click "Publish new version" from the "Actions" menu. Put the Datadog Forwarder version (e.g., 3.0.1) in the description for reference.
1. Click "Create alias" from the "Actions" menu, name it `live` and point it to the version that was just published.
1. Now you can set up triggers against the Datadog Forwarder `live` alias (e.g., the ARN should be `arn:aws:lambda:us-east-1:xxxx:function:serverlessrepo-Datadog-Forwarder-xxxx:live`), instead of the unqualified version. This ensures a safe and gradual upgrade in the future. Learn more about [AWS Lambda alias](https://docs.aws.amazon.com/lambda/latest/dg/configuration-aliases.html).
1. You can either manually subscribe the Datadog Forwarder Lambda function to the desired CloudWatch Log groups or S3 buckets, or let Datadog [manage the triggers automatically for you](https://docs.datadoghq.com/integrations/amazon_web_services/?tab=allpermissions#automatically-setup-triggers).

## Upgrade

Follow the steps below to upgrade an existing installation of the Datadog Forwarder.

1. Make sure the triggers (S3 and CloudWatch Log events) are against the Datadog Forwarder lambda function alias, rather than the unqualified version. If not, follow the steps in the [Triggers section](#triggers) to create an alias and update the existing triggers to be against the alias. This ensures a [gradual upgrade](https://docs.aws.amazon.com/lambda/latest/dg/configuration-aliases.html) next.
1. Open a new tab and navigate to the [Datadog Forwarder SAM application](https://serverlessrepo.aws.amazon.com/applications/arn:aws:serverlessrepo:us-east-1:464622532012:applications~Datadog-Log-Forwarder) and "Deploy".
1. Configure the application settings.
   1. The `Application name` **MUST** be the same as the existing Datadog Forwarder application, in order to *update* the CloudFormation stack behind the scene. Please ignore the SAM prefix `serverlessrepo-`, e.g., if your existing forwarder's application name is `serverlessrepo-DatadogForwarder`, enter `DatadogForwarder` for application name.
   1. The `FunctionName` **MUST** be the same as the existing Datadog Forwarder Lambda function, which defaults to `DatadogForwarder`.
   1. Configure the rest of the application settings based the settings (environment variables) of the existing Datadog Forwarder.
1. Click "Deploy", and the unqualified version (i.e. $LATEST) of `DatadogForwarder` will be updated in a few minutes. This shouldn't affect anything until you point the `live` alias to the new version of the Lambda.
1. Copy over any missing environment variables for advanced settings from the `live` forwarder to the new (unqualified) version.
1. If you have directly customized the source code of the forwarder perviously, you need to copy over the changes manually to the unqualified version.
1. Click "Publish new version" from the "Actions" menu. Put the Datadog Forwarder version (e.g., 3.0.1) in the description for reference.
1. Switch to the `live` alias, and set the newly published version as the additional version.
1. Adjust the weight gradually to shift traffic from the old version to the new.
1. If the new version works fine, point the `live` alias to the new version completely. Otherwise, point the `live` alias back to the old version, and report the issue to Datadog support.

## Notes

* For S3 logs, there may be some latency between the time a first S3 log file is posted and the Lambda function wakes up.
